#include <effect.h>

mapping Locate = ([
	"11"	: ({ 56,56,66,25,88,57,98,28,110,36,114,66,115,42,123,46, }),
	"12"	: ({ 82,87,98,82,105,144,107,162,111,96,118,177,120,108,122,147,123,152,129,115,138,152,139,106,155,147,157,170,169,122,174,166,189,129,199,117,211,111,213,161, }),
	"13"	: ({ 57,141,75,152,90,164,95,160,120,155,125,144,135,171,140,187,142,169,168,199,178,156,193,152,200,177,201,131,201,169,213,135,238,131, }),
	"14"	: ({ 54,112,66,110,87,107,88,62,97,68,99,99,99,124,104,74,118,163,148,171,157,180,181,168,182,156,229,101,244,92,249,94, }),
	"15"	: ({ 72,94,74,118,79,103,111,118,120,110,133,134,157,131,170,128,171,120,175,193,182,167,184,132,190,174,199,133,200,170,213,142,224,161,232,133, }),	
	"31"	: ({ 50,47,60,54,61,41,67,45,71,63,79,47,80,69,142,98,153,106,154,125,157,113,170,139, }),
	"32"	: ({ 64,86,71,107,73,94,81,113,83,101,90,119,91,106,99,126,100,112,189,139,191,151,200,131,51,75,52,91,62,100,202,144,208,126,236,129,242,123, }),
	"33"	: ({ 42,100,49,109,50,94,68,95,71,80,117,58,125,59,136,53,147,85,183,103,191,94,213,109,220,114, }),
	"51"	: ({ 27,97,37,90,54,114,71,111,77,140,87,123,91,151,108,136,111,156,124,151,127,168,145,167,155,189,168,179,172,190,196,160,196,173,215,161,219,141,242,138,250,118,269,118, }),
	"52"	: ({ 32,86,36,104,53,103,54,119,70,116,71,130,87,127,87,142,105,129,120,117,121,131,129,107,134,121,140,99,156,90,158,113,165,98,176,75,191,88,208,86,214,105, }),
	"53"	: ({ 36,107,36,122,56,94,56,107,75,79,76,94,90,67,93,79,111,47,111,69,128,38,130,60,181,49,197,48,211,71,227,68,227,85,244,83,246,98,263,95,270,115,275,119,287,113,287,128, }),
	"71"	: ({ 60,61,78,90,122,123,142,123,147,139,152,129,171,156,177,147,178,161,188,139,213,135,220,116, }),
	"72"	: ({ 43,53,52,72,70,70,87,94,116,100,119,118,139,119,142,136,147,150,159,131, }),
	"73"	: ({ 47,39,56,31,66,53,68,40,68,65,80,51,83,73,96,58,107,69,107,84,125,99,126,85,143,99,145,116,158,133,165,117,172,147,177,122, }),
	"91"	: ({ 65,102,69,117,70,106,78,64,81,109,82,57,102,36,102,77,104,28,104,141,171,126,172,95,174,71,195,145,147,147,149,101, }),
	"92"	: ({ 58,114,60,97,60,107,88,128,92,138,116,123,123,64,146,68,147,58,161,73,192,126,195,70,196,51,196,119,218,89,177,88,180,106,93,60,101,66, }),
	"93"	: ({ 107,131,107,140,109,93,111,41,130,151,131,58,132,50,135,32,135,135,138,22,165,110,167,26,178,36,192,84,194,95,86,145,92,128,95,76, }),
	"111"	: ({ 39,93,67,91,77,105,83,109,114,105,115,125,121,140,122,46,125,147,130,165,138,91,141,166,157,62,159,164,172,92,194,138,205,94,211,126,224,113,236,104, }),
	"112"	: ({ 57,80,68,83,82,60,89,101,94,52,101,127,108,123,134,141,136,50,138,139,147,166,160,97,160,150,170,57,191,78,194,106,205,86, }),
	"172"	: ({ 95,36,122,69,131,110,131,129,132,137,138,144,146,91,146,142,150,120,150,142,157,156,170,154,190,152,225,182,231,155,240,170,258,152, }),
	"173"	: ({ 87,101,114,95,131,88,133,83,135,45,143,93,153,47,161,106,175,73,179,123,187,157,208,143,218,162,222,107,224,122, }),
	"174"	: ({ 78,80,93,92,125,94,146,120,152,102,161,137,177,136,182,194,199,183,202,135,203,208,210,158,227,212,229,144,247,200,249,162,261,184, }),
	"265"	: ({ 65,83,83,92,91,102,92,70,92,125,108,58,113,134,123,58,130,113,133,126,139,67,156,77,168,153,181,114,181,171,184,110,185,86,186,135,197,125,206,189,215,194,235,225,245,236, }),
	"266"	: ({ 70,135,91,64,95,155,114,44,124,95,125,153,135,86,141,106,142,57,143,25,143,139,150,20,155,79,161,35,163,51,165,116,168,109,187,130,199,124,213,129,235,111,248,130, }),
	"291"	: ({ 74,64,76,70,77,56,79,49,80,109,80,114,83,72,86,81,114,115,117,137,119,55,120,103,125,112,125,147,149,143,151,155,163,163,165,114,166,142,223,97,226,104, }),
	"292"	: ({ 137,164,142,70,142,127,144,106,147,163,155,78,155,156,157,84,157,91,157,106,208,140,211,107,212,128,214,87,82,122,88,118,90,124,184,71,187,106,188,146,189,102, }),
	"293"	: ({ 94,86,96,76,96,145,97,106,101,163,102,77,103,99,105,153,106,111,106,135,34,121,39,111,40,125,47,111,48,129,51,101,55,116,156,86,158,104,159,140,162,63, }),
	"311"	: ({ 88,89,115,95,129,163,134,140,137,106,140,82,152,126,156,160,158,112,162,90,165,49,169,140,181,127,186,99,189,66,189,140,204,73,205,95,220,87, }),
	"312"	: ({ 50,80,56,95,77,109,77,121,90,138,105,135,113,38,116,161,124,54,128,142,138,162,144,36,147,114,151,143,157,116,158,129,164,45,173,71,175,82,185,98,194,71, }),
	"313"	: ({ 17,90,22,82,22,98,30,93,34,82,37,104,39,68,40,96,45,76,74,94,75,125,152,36,154,47,154,64,170,120,173,82,210,91,223,89, }),
	"321"	: ({ 31,80,39,73,44,77,51,72,52,63,55,69,59,66,81,70,83,58,85,74,85,86,89,55,89,96,108,103,109,40,109,132,110,110,123,67, }),
	"322"	: ({ 48,66,51,91,51,99,59,85,59,93,76,59,76,80,76,88,79,98,94,53,94,115,95,114,96,59,99,49,101,77,102,109,104,115,106,44,107,105,113,79, }),
	"323"	: ({ 66,79,68,102,70,48,71,106,93,31,93,67,93,126,106,46,106,104,108,136,109,43,109,120,113,102,113,126,115,55,126,91,129,114,140,80,142,103,143,113, }),
	"331"	: ({ 87,139,91,121,97,156,100,122,101,113,109,156,110,94,110,107,126,93,131,42,131,143,139,143,140,162,141,57,143,33,143,182,150,67,201,137,202,117, }),
	"332"	: ({ 83,110,84,115,89,95,96,67,100,92,129,65,131,115,135,60,138,106,143,60,144,119,145,127,163,107,164,62,171,139,172,111,178,67, }),
	"333"	: ({ 116,142,117,56,120,74,120,150,128,75,134,160,139,88,143,86,143,163,152,170,153,47,154,116,221,103,225,95,229,79, }),
	"334"	: ({ 94,40,96,61,103,106,108,115,110,35,124,168,128,65,128,106,129,49,144,74,144,106,149,62,150,114,150,139,187,133,215,95, }),
	"335"	: ({ 79,120,83,134,84,112,84,140,91,82,93,118,107,158,108,70,108,158,118,138,122,144,122,164,177,106,179,46,185,151,186,107, }),
	"341"	: ({ 123,74,139,99,140,61,142,75,150,54,153,53,156,78,156,157,174,144,180,79,204,90,244,66,281,95,283,150, }),
	"342"	: ({ 104,94,121,108,139,36,144,63,151,130,162,57,172,84,174,157,181,41,184,124,195,116,199,134,211,77,228,101, }),
	"343"	: ({ 44,46,46,67,49,96,58,77,71,117,72,88,73,32,75,43,89,13,91,129,92,31,95,104,102,118,103,32,107,18,109,27,116,69,121,28,122,113,138,92,143,41,150,79, }),
	"344"	: ({ 70,123,72,92,72,139,85,93,92,78,95,124,112,84,129,116,130,79,137,100,143,94,147,104,157,138,163,85,169,92,172,131,202,105,209,99, }),
	"345"	: ({ 52,53,78,106,79,94,80,39,81,72,95,83,95,118,109,41,110,126,110,138,121,71,129,110,131,38,134,24,143,88,145,45,145,52,146,39,159,46,166,108,194,88, }),
	"372"	: ({ 88,141,106,120,108,156,109,128,110,64,134,130,137,44,141,104,141,126,152,105,152,118,158,47,160,112,161,107,179,97,181,67,186,70, }),
	"373"	: ({ 86,123,87,56,88,104,118,115,121,127,123,38,142,62,144,116,147,121,162,74,168,105,179,80,50,75,72,65,124,45,129,107, }),
	"374"	: ({ 65,123,68,96,69,96,74,84,108,59,110,30,141,124,142,118,146,39,163,74,49,112,57,83,163,81,164,52,128,115,134,36, }),
	"381"	: ({ 81,81,86,110,92,126,101,87,109,102,118,127,123,60,129,41,134,26,139,185,142,154,147,173,153,66,160,39,160,151,176,84,200,121,203,137,206,106,221,106, }),
	"383"	: ({ 75,37,100,126,102,11,104,74,110,88,112,53,119,106,119,135,132,29,132,142,135,123,136,104,149,149,154,91,157,74,160,136,163,122,170,105,172,92,197,86,203,100, }),
	"385"	: ({ 29,93,29,104,49,86,52,69,59,59,62,117,65,53,74,139,78,108,86,43,87,98,90,151,106,39,111,137,130,79,130,99,138,124,146,21,148,136,149,33,149,87,162,81,169,90,169,110,195,54,198,103, }),
	"391"	: ({ 9,89,31,88,33,71,49,121,57,61,71,130,72,58,89,143,95,66,96,135,102,151,113,142,116,48,128,39,133,147,140,31,149,141,152,129,152,148,171,137,172,79,186,128,188,93,196,107,205,114,213,103,215,89,230,95, }),
	"392"	: ({ 11,101,28,94,36,78,41,113,46,98,59,70,74,63,74,112,76,96,89,159,90,98,95,83,109,175,117,157,119,142,133,192,136,117,147,136,164,132,171,198,173,113,181,185,182,133,197,173,210,125,213,156,225,138,226,157,243,145, }),
	"393"	: ({ 12,82,26,81,61,93,70,118,71,42,72,109,76,49,82,91,92,38,108,110,127,23,132,134,139,38,140,169,158,75,166,139,181,127,182,91,197,74,208,91,228,101, }),
	"501"	: ({ 45,134,93,164,110,180,133,177,138,186,147,41,148,208,171,107,173,24,175,142,200,46,209,132,225,82,300,121, }),
	"502"	: ({ 45,134,93,164,110,180,133,177,138,186,147,41,148,208,171,107,173,24,175,142,200,46,209,132,225,82,300,121, }),
	"503"	: ({ 44,132,60,140,93,164,100,172,112,181,126,182,142,171,148,208,170,143,195,114,200,49,205,194,300,121, }),
	"504"	: ({ 63,154,93,164,105,175,118,184,129,51,140,172,151,190,161,23,162,116,165,71,173,139,175,102,193,47,194,101,200,190,209,109,211,87,211,136,235,164,240,116,278,108, }),
	"505"	: ({ 35,131,51,113,77,161,98,171,100,156,110,76,114,183,133,197,137,174,139,56,157,222,169,24,179,32,190,53,209,188,245,164,270,104,291,123, }),
	"506"	: ({ 92,78,93,164,106,175,109,150,118,184,121,61,129,51,130,190,155,25,165,88,170,23,193,48,200,199,211,112,273,135,281,134,282,110,289,118, }),
	"507"	: ({ 47,145,77,161,94,167,96,69,114,183,120,62,131,178,146,168,173,38,173,67,193,48,198,122,290,124, }),
	"508"	: ({ 73,161,91,112,93,163,109,175,131,195,138,56,172,148,176,109,187,43,196,105,243,97,270,104,291,123, }),
	"509"	: ({ 36,123,56,104,56,107,72,92,73,161,79,142,100,156,104,153,114,165,116,182,139,56,167,68,169,109,172,148,186,44, }),
	"510"	: ({ 41,124,51,134,59,109,61,141,67,107,70,145,76,151,81,156,90,143,254,150,256,137,258,145,264,137,270,103,270,140,278,134,285,132,287,122, }),
	"511"	: ({ 42,124,47,111,51,133,58,108,61,141,65,110,70,106,71,146,76,151,153,78,235,171,245,153,250,148,254,136,270,103,271,139,279,113, }),
	"512"	: ({ 61,141,71,146,86,155,91,150,98,163,150,76,171,178,220,175,239,167,249,159,258,145,271,139,283,112, }),
	"513"	: ({ 48,133,53,110,53,132,69,144,73,105,91,150,92,158,117,59,206,191,215,190,228,170,236,170,244,164,249,151,257,148,271,102,276,139,283,112, }),
	"514"	: ({ 34,133,99,179,159,80,165,229,176,224,182,105,198,191,207,97,226,85,235,67,288,129,303,125, }),
	"515"	: ({ 43,132,59,140,91,147,93,164,100,172,112,181,134,110,138,188,148,208,177,213,200,49,283,113,299,128, }),
	"516"	: ({ 59,133,93,164,100,172,116,144,118,184,125,196,126,181,145,167,159,27,173,140,196,50,261,160, }),
	"517"	: ({ 47,135,93,164,103,174,111,180,162,216,166,30,166,73,174,139,190,209,197,116,261,107,298,123, }),
	"518"	: ({ 30,126,125,134,154,163,167,224,190,35,204,100,213,95,220,55,235,67,269,115,302,123, }),
	"519"	: ({ 29,126,33,131,127,135,160,225,191,35,213,95,224,159,234,66,259,93,260,116,300,123, }),
	"520"	: ({ 64,112,70,120,101,146,137,128,149,178,154,186,170,197,175,135,190,200,222,186,274,130, }),
	"521"	: ({ 63,115,114,93,121,126,123,167,133,153,139,118,196,174,212,172,241,151,243,106,268,121, }),
	"522"	: ({ 62,114,121,130,142,119,151,181,159,91,181,133,181,161,184,56,212,172,223,121,239,92,270,121, }),
	"523"	: ({ 32,122,97,180,144,146,151,86,177,221,197,173,202,56,207,96,230,78,236,69,298,129, }),
	"524"	: ({ 131,61,132,199,145,68,158,150,159,196,167,94,171,203,173,136,175,37,206,78,213,109,226,158,231,88,248,159,280,133, }),
	"525"	: ({ 74,146,76,115,80,160,132,59,145,66,152,48,173,39,206,58,207,75,213,108,219,116,231,88,231,99,233,169,236,135, }),
	"526"	: ({ 86,95,94,123,111,49,131,118,133,65,153,51,157,150,162,187,168,94,185,44,206,58,227,156, }),
	"527"	: ({ 64,101,132,61,137,200,159,194,176,38,187,181,206,78,215,117,224,83,226,158,231,89,254,123, }),
	"528"	: ({ 53,119,74,146,81,159,106,64,144,71,159,196,160,60,168,95,170,134,219,117,230,86,231,99,232,170,235,135, }),
	"529"	: ({ 82,100,88,116,94,91,101,150,102,162,118,73,131,117,145,171,157,149,166,57,168,48,168,95,185,45,194,176,205,57,214,74,226,158,236,140, }),
	"530"	: ({ 80,79,80,101,91,125,101,160,102,149,107,112,116,65,120,47,130,118,151,49,168,48,172,120,190,172,194,148,206,58,226,157,236,141, }),
	"531"	: ({ 47,135,51,119,93,164,105,175,112,181,126,182,127,92,137,117,166,28,189,212,198,48,275,109,299,124, }),
	"532"	: ({ 46,135,50,119,56,138,87,156,92,165,103,173,118,184,125,197,126,182,160,218,164,32,171,68,189,214,192,170,197,116,200,55,261,107,299,124, }),
	]);

string * place1 = ({ "265", "266", "111", "112", "011", "012", "013", "014", "015", "171", "501", "502", "503", "528", "529", "530",  });
string * place2 = ({ "265", "266", "111", "112", "011", "012", "013", "014", "015", "171", "172", "173", "174", "071", "072", "073", "501", "502", "503", "528", "529", "530", "512", "513",  });
string * place3 = ({ "071", "072", "073", "031", "032", "033", "051", "052", "053", "321", "322", "323", "311", "312", "313", "331", "332", "333", "334", "335", "341", "342", "343", "344", "345", "512", "513", "510", "511", "524", "525", "526", "527", "516", "517", "514", "515", "504", "505", "508", "509",  });
string * place4 = ({ "331", "332", "333", "334", "335", "341", "342", "343", "344", "345", "291", "292", "293", "381", "383", "385", "504", "505", "508", "509", "506", "507", "520", "522",  });
string * place5 = ({ "381", "383", "385", "372", "373", "374", "091", "092", "093", "391", "392", "393", "520", "522", "521", "523", "5361", "532", "518", "519",  });

string * keyname = ({ "Chìa Khóa Đồng", "Chìa Khoá Tinh Thiết", "Chìa Khoá Ngân", "Chìa Khoá Vàng", "Chìa Khoá Huyền Thiết",  });

object * stuffs = ({ });	

// 函数：生成二进制码
void SAVE_BINARY() { }

void reset_stuff();

// 函数：构造处理
void create() 
{
//	reset_stuff();
}

int get_xy(int z)
{
	int * pos, size, i, p;
	string name = sprintf("%d", z);
	pos =  Locate[name];
	if (!pos) pos = Locate["265"];
	size = sizeof(pos);
	i = random(size/2);
	p = get_valid_xy(z, pos[i*2], pos[i*2+1], IS_CHAR_BLOCK);
	if (p==0) p = pos[i]*1000+pos[i+1];

	return p;
}

void del_stuff()
{
	int i, size;
	size = sizeof(stuffs);
	if (size==0) return;
	for (i=0;i<size;i++)
	{
		if (objectp(stuffs[i]))
		{
			stuffs[i]->remove_from_scene();
			destruct(stuffs[i]);
		}
	}
	stuffs = ({ });
}

void reset_stuff()
{
	int i, j, size;
	object npc;
	del_stuff();
	size = sizeof(place1);
	for (i=0;i<size;i++)
	{
		npc = new ("/npc/00/box1");
		if (npc)
		{
			npc->set("z", to_int(place1[i]));
			npc->reset_stuff(npc);
			stuffs += ({ npc });
		}		
	}
	size = sizeof(place2);
	for (i=0;i<size;i++)
	{
		npc = new ("/npc/00/box2");
		if (npc)
		{
			npc->set("z", to_int(place2[i]));
			npc->reset_stuff(npc);
			stuffs += ({ npc });
		}		
	}
	size = sizeof(place3);
	for (i=0;i<size;i++)
	{
		npc = new ("/npc/00/box3");
		if (npc)
		{
			npc->set("z", to_int(place3[i]));
			npc->reset_stuff(npc);
			stuffs += ({ npc });
		}		
	}
	size = sizeof(place4);
	for (i=0;i<size;i++)
	{
		npc = new ("/npc/00/box4");
		if (npc)
		{
			npc->set("z", to_int(place4[i]));
			npc->reset_stuff(npc);
			stuffs += ({ npc });
		}		
	}
/*	
	size = sizeof(place5);
	for (i=0;i<size;i++)
	{
		npc = new ("/npc/00/box5");
		if (npc)
		{
			npc->set("z", to_int(place5[i]));
			npc->reset_stuff(npc);
			stuffs += ({ npc });
		}		
	}	
*/				
}

int get_all_stuff()
{
	return sizeof(stuffs);
}

void check_locate()
{
	string * name; 
	int * pos;
	int i, j, size, size2;
	int z;
	name = keys(Locate);
	size2 = sizeof(name);
	for (i=0;i<size2;i++)
	{
		pos = Locate[name[i]];
		size = sizeof(pos);
		for (j=0;j<size/2;j++)
		{
			if (get_valid_xy(to_int(name[i]), pos[2*j], pos[2*j+1], IS_CHAR_BLOCK)==0)
			{
log_file("checkstuff2.dat", sprintf("地图：%s 第几行：%d 坐标(%d,%d)\n", name[i], j+1, pos[2*j], pos[2*j+1]));								
			}
			if (get_block(to_int(name[i]), pos[2*j], pos[2*j+1])&IS_MAP_BLOCK) 
			{
log_file("checkstuff.dat", sprintf("地图：%s 第几行：%d 坐标(%d,%d)\n", name[i], j+1, pos[2*j], pos[2*j+1]));				
			}
		}
	}
}

void do_look(object me , object who)
{
	int level = who->get("level");
	object item;
	string name;
	if (level<1||level>5) return;
	if (get_effect(me, EFFECT_PROGRESS2)) return ;
	if (get_effect_3(me, EFFECT_MAGIC_4243)) return ;
	if (me->is_die()) return ;
	if (get_effect_3(me, EFFECT_CHAR_LAZY)) return ;
	if (get_effect_3(me, EFFECT_CHAR_SLOW)) return ;
	if (get_effect_3(me, EFFECT_CHAR_DREAM_1)) return ;
	if (get_effect_3(me, EFFECT_CHAR_CHAOS)) return ;
	if (get_effect_3(me, EFFECT_CHAR_FAINT)) return ;
	if (get_effect_3(me, EFFECT_SLEEP)) return ;
	if (get_effect_3(me, EFFECT_CHAR_NO_MOVE)) return ;
        if( sizeof_inventory(me, 1, MAX_CARRY) >= MAX_CARRY )
        {
                send_user(me, "%c%s", '!', "Hành trang không đủ ô trống");
                return;
        }	
        if (me->get_strength()<5)
        {
                send_user(me, "%c%s", '!', "Thể lực không đủ 5 điểm, không thể mở "+who->get_name()+".");
                return;
        }        
	level --;
	name = keyname[level];
	item = present(name, me, 1, MAX_CARRY);
	if ( !item ) 
	{
		send_user(me, "%c%s", '!', "Bạn không có "+name+", không thể mở ra "+who->get_name()+"!");
		return;
	}
        set_effect(me, EFFECT_PROGRESS2, 6 );
        me->set_progress_file(get_file_name(who));	
        me->set_progress_arg( who->get_char_id());
	send_user(me, "%c%c%w%s", 0x5a, 0, 6, "Mở "+who->get_name()+"……");		
        if (get_effect_3(me, EFFECT_CHAR_INVISIBLE))
        {
        	set_effect_2(me, EFFECT_CHAR_INVISIBLE, 1, 1 );
        }	
}

void into_effect(object me, string arg)
{
	int level;
	object item, who;
	string name, file;
	int i, size;
	if( !objectp( who = find_char(me->get_progress_arg()) ) )
	{
		send_user(me, "%c%c%c", 0x5a, 1, 0);
		return;
	}	
	level = who->get("level");
	if (level<1||level>5) return;
        if( sizeof_inventory(me, 1, MAX_CARRY) >= MAX_CARRY )
        {
                send_user(me, "%c%s", '!', "Hành trang không đủ ô trống");
                send_user(me, "%c%c%c", 0x5a, 1, 0);
                return;
        }	
        if (me->get_strength()<5)
        {
                send_user(me, "%c%s", '!', "Thể lực không đủ 5 điểm, không thể mở "+who->get_name()+".");
                send_user(me, "%c%c%c", 0x5a, 1, 0);
                return;
        }        
	level --;
	name = keyname[level];
	item = present(name, me, 1, MAX_CARRY);
	if ( !item ) 
	{
		send_user(me, "%c%s", '!', "Bạn không có "+name+", không thể mở ra "+who->get_name()+"!");
		send_user(me, "%c%c%c", 0x5a, 1, 0);
		return;
	}		
	if (get_z(me)!=get_z(who)||abs(get_x(me)-get_x(who))>5||abs(get_y(me)-get_y(who))>5)
	{
		send_user(me, "%c%c%c", 0x5a, 1, 0);
		return;
	}	
	item->add_amount(-1);
	send_user(me, "%c%c%c", 0x5a, 1, 1);
	me->add_strength(-5);
	file = get_file_name(who);
	file->drop_item(me);
	who->add("time", -1);
	if (who->get("time")<=0)
	{		
		who->wait_for_reset(who);		
		return;
	}		
}